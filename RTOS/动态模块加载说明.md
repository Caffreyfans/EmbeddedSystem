# 动态模块加载说明

最近在调试基于 zynq 的动态模块加载功能，发现动态模块在加载到内存中后，去执行相关代码时，大概率系统会跑飞掉，有时会执行一些莫名其妙的指令，出现 undefined instruction 错误，或者是代码跑飞掉，pc 运行到一些神奇的地址，例如 0x00000004，这种位置，导致 data abort。

经过几轮调试，没有发现系统中有什么逻辑上的 bug，陷入僵局。后来经过他人提示，检查在动态加载的过程中对 cache 是否进行了正确处理，这才找到问题所在。

如果在跳转到动态模块的入口地址运行程序前，没有对 cache 进行正确操作，那么很有可能加载的数据还在 cache 中，还没有被成功写入到内存中正确的位置，此时去运行该地址中的指令，则会发现，这些指令都是一些乱码，使系统行为异常。

因此，在跳转到动态模块入口地址运行前，需要对 cache 执行如下操作：

- flush dcache      将数据 cache 中的数据写入到内存中
- invalid icache    将指令 cache 中的数据无效化，重新读取后续要执行的指令

通过这两个操作，就可以保证我们加载的动态模块被实实在在地写入了内存中，无效指令cache，使得接下来 cpu 要执行的指令也确实是我们加载到内存中的，动态模块的指令。

## 结论

发现数据异常，执行的相关指令为非常奇怪的指令时，可以查看相关内存，检查是否是由于 cache 没能同步导致的。